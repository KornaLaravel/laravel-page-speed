# Web Optimization Playbook (Blade / HTML)

Highly technical guidance for adopting the Laravel Page Speed HTML pipeline without sacrificing rendering integrity or developer ergonomics.

---

## Table of Contents

- [1. Overview](#1-overview)
- [2. Pipeline Architecture](#2-pipeline-architecture)
- [3. Installation and Baseline Setup](#3-installation-and-baseline-setup)
- [4. Middleware Reference](#4-middleware-reference)
- [5. Integration Patterns](#5-integration-patterns)
- [6. Instrumentation and Benchmarking](#6-instrumentation-and-benchmarking)
- [7. Validation Strategy](#7-validation-strategy)
- [8. Troubleshooting](#8-troubleshooting)

---

## 1. Overview

The HTML pipeline targets three objectives:

1. **Reduce transfer size** with deterministic minification operations that retain semantic whitespace.
2. **Improve time-to-first-render** by deferring non-critical assets and hinting network lookups.
3. **Maintain compatibility** across reactive ecosystems (Livewire, Alpine.js, Inertia, Filament) via opt-out markers and safe parsing heuristics.

Laboratory benchmarks show a 30–35% reduction in HTML payload and a 33% faster First Paint on representative Blade applications instrumented with Lighthouse.

---

## 2. Pipeline Architecture

The HTML optimizer is expressed as a deterministic sequence of PSR-15 style middleware. Each stage operates on the response body with guardrails that prevent double-processing:

1. **InlineCss** – hashes recurring inline styles and emits a consolidated `<style>` block in the document head.
2. **ElideAttributes** – removes HTML attributes whose values match W3C defaults.
3. **InsertDNSPrefetch** – scans third-party origins and additively injects `<link rel="dns-prefetch">` hints.
4. **CollapseWhitespace** – orchestrates comment removal, whitespace collapse, and tag compaction.
5. **DeferJavascript** – appends the `defer` attribute to synchronous `<script>` tags that are safe to postpone.

The ordering matters: CSS consolidation runs before attribute elision to avoid mangling synthetic class names, and whitespace collapse runs before script deferral to ensure comment removal does not invalidate JS parsing.

---

## 3. Installation and Baseline Setup

1. Install and publish assets:

   ```bash
   composer require vinkius-labs/laravel-page-speed
   php artisan vendor:publish --provider="VinkiusLabs\\LaravelPageSpeed\\ServiceProvider"
   ```

2. Register the middleware according to your Laravel major version:

   **Laravel 10.x – `app/Http/Kernel.php`**

   ```php
   protected $middlewareGroups = [
       'web' => [
           // existing entries …
           \VinkiusLabs\LaravelPageSpeed\Middleware\InlineCss::class,
           \VinkiusLabs\LaravelPageSpeed\Middleware\ElideAttributes::class,
           \VinkiusLabs\LaravelPageSpeed\Middleware\InsertDNSPrefetch::class,
           \VinkiusLabs\LaravelPageSpeed\Middleware\CollapseWhitespace::class,
           \VinkiusLabs\LaravelPageSpeed\Middleware\DeferJavascript::class,
       ],
   ];
   ```

   **Laravel 11.x / 12.x – `bootstrap/app.php`**

   Extend the existing `->withMiddleware` closure generated by the Laravel 11 skeleton:

   ```php
   use Illuminate\Foundation\Configuration\Middleware;

   return Application::configure(basePath: __DIR__.'/../')
       // ... other configuration calls
       ->withMiddleware(function (Middleware $middleware) {
           $middleware->appendToGroup('web', [
               \VinkiusLabs\LaravelPageSpeed\Middleware\InlineCss::class,
               \VinkiusLabs\LaravelPageSpeed\Middleware\ElideAttributes::class,
               \VinkiusLabs\LaravelPageSpeed\Middleware\InsertDNSPrefetch::class,
               \VinkiusLabs\LaravelPageSpeed\Middleware\CollapseWhitespace::class,
               \VinkiusLabs\LaravelPageSpeed\Middleware\DeferJavascript::class,
           ]);

           // keep other group definitions here (api, broadcast, etc.)
       })
       ->create();
   ```

3. Configure skip patterns in `config/laravel-page-speed.php` to exclude diagnostic tooling, binary downloads, or embedded HTML fragments:

   ```php
   'skip' => [
       '_debugbar/*',
       'telescope/*',
       'horizon/*',
       '*.pdf',
       'admin/reports/*',
       'exports/*',
   ],
   ```

4. Disable globally when readability is preferred (e.g., local development):

   ```env
   LARAVEL_PAGE_SPEED_ENABLE=false
   ```

---

## 4. Middleware Reference

| Middleware                        | Category         | Primary Effect                                     | Opt-outs                         |
|-----------------------------------|------------------|----------------------------------------------------|----------------------------------|
| `InlineCss`                       | Structural       | Deduplicates inline styles into deterministic CSS  | `data-ps-inline="false"`        |
| `ElideAttributes`                | Semantics        | Drops default attributes (`type="text"`, etc.)      | `data-ps-keep-attr`              |
| `InsertDNSPrefetch`              | Networking       | Adds DNS prefetch hints for external origins       | Remove middleware or skip route                      |
| `CollapseWhitespace` (incl. `RemoveComments`) | Compression | Collapses whitespace, removes HTML/JS/CSS comments | `data-ps-preserve="true"`        |
| `DeferJavascript`                | Rendering        | Adds `defer` to safe `<script>` tags               | `data-pagespeed-no-defer`        |
| `RemoveQuotes` *(optional)*      | Aggressive       | Removes quotes from simple attributes              | Global toggle; off by default    |
| `TrimUrls` *(optional)*          | Aggressive       | Rewrites absolute URLs to relative paths           | Global toggle; off by default    |

### InlineCss
- Generates idempotent class names (`ps-inline-hash`) scoped per response.
- Excludes selectors with dynamic tokens (`{{ }}`) or Blade control structures.
- Benefits: increased gzip effectiveness, centralised caching semantics.

### ElideAttributes
- Follows WHATWG defaults. Examples: `type="submit"` on `<button>`, `method="get"` on `<form>`, `type="text/javascript"` on `<script>`.
- Safe with Livewire/Alpine because data attributes are never removed.

### InsertDNSPrefetch
- Parses `src`, `href`, and `data-*` references for absolute URLs.
- Deduplicates origins and injects hints into `<head>` without altering CSP.
- Can be combined with `<link rel="preconnect">` by setting `ps_preconnect_hosts` config array.

### CollapseWhitespace / RemoveComments
- Maintains verbatim content inside `<pre>`, `<code>`, `<textarea>`, and elements with `data-ps-preserve`.
- JS comment stripping honors `http(s)://` patterns to avoid breaking URLs.
- HTML conditional comments `<!--[if IE]>` are retained by explicit whitelist.

### DeferJavascript
- Adds `defer` when **all** conditions are met:
  - Tag uses `src` (no inline scripts).
  - Absent `async`, `defer`, or `nomodule` attributes.
  - Not marked with `data-pagespeed-no-defer`.
- Keeps execution order stable, enabling faster FCP without losing script dependencies.

### Optional Aggressive Passes
- `RemoveQuotes` and `TrimUrls` remain disabled by default. Enable them only after verifying templates do not rely on quoted attributes or absolute URLs (e.g., for email clients or canonical links).

---

## 5. Integration Patterns

### Global HTML Output
Apply middleware to the global stack for consistent results across SSR routes and Inertia responses.

### Route-Scoped
Wrap individual controllers with middleware groups to keep admin panels pristine while still optimizing public marketing pages:

```php
Route::middleware(['page-speed.html'])->group(function () {
    Route::view('/', 'landing.index');
    Route::view('/pricing', 'landing.pricing');
});
```

### Conditional Skipping
Add runtime guards in controllers for outputs that must remain unaltered (e.g., PDF rendering or signed HTML exports):

```php
if (app()->bound('pagespeed.skip')) {
    app('pagespeed.skip')();
}
```

---

## 6. Instrumentation and Benchmarking

- Use [Lighthouse CI](https://github.com/GoogleChrome/lighthouse-ci) or WebPageTest to capture FCP/LCP before and after activation.
- Add server-side timing with Symfony Stopwatch or Laravel Telescope to measure response serialization deltas (typically <3 ms per response).
- Export metrics by enabling the API Performance Headers middleware even on Blade routes to retrieve `X-Response-Time` and `X-Memory-Usage`.

Sample `pwsh` script for repeatable benchmarks:

```powershell
1..5 | ForEach-Object {
    Invoke-WebRequest https://localhost/pricing | Select-Object -ExpandProperty RawContentLength
}
```

---

## 7. Validation Strategy

1. **Unit Coverage** – extend Blade view tests to assert HTML fragments using `assertDontSee` for removed comments/attributes.
2. **Snapshot Testing** – store golden HTML fixtures (pre/post) and diff them via PHPUnit snapshot libraries.
3. **Interactive QA** – verify Livewire components, Alpine transitions, and third-party widgets to confirm opt-out markers.
4. **Synthetic Monitoring** – wire Chrome UX Report or SpeedCurve synthetic monitors to detect regressions in FCP/LCP.

---

## 8. Troubleshooting

| Symptom                                   | Root Cause                                             | Mitigation                                                     |
|-------------------------------------------|--------------------------------------------------------|----------------------------------------------------------------|
| Missing whitespace in `<pre>` blocks      | Element not automatically detected                     | Add `data-ps-preserve="true"` or disable CollapseWhitespace.   |
| JS bundle fails due to comment removal    | Inline IIFE assumed comment presence                   | Mark script with `data-pagespeed-no-defer` and skip removal.   |
| CDN requests still incur DNS lookups      | Prefetch hints not processed by CSP                    | Extend CSP `prefetch-src` directive or enable `preconnect`.    |
| Forms losing default behaviour            | Attribute elision undesired in specific template       | Add `data-ps-keep-attr` to element or disable ElideAttributes. |
| AMP/email templates break                 | Optional passes removing quotes or rewriting URLs      | Leave advanced toggles off or create dedicated skip routes.    |

When in doubt, instrument templates with Blade comments showing the current middleware flags to surface configuration quickly.

**Configuration**: Disabled by default. Test thoroughly before enabling.

---

## Compatibility

### ✅ Compatible Frameworks

| Framework | Status | Notes |
|-----------|--------|-------|
| **Laravel Livewire** | ✅ Fully Compatible | Preserves `wire:*` directives |
| **Filament** | ✅ Fully Compatible | Tested with admin panels |
| **Inertia.js** | ✅ Fully Compatible | Works with Vue/React |
| **Alpine.js** | ✅ Fully Compatible | Preserves `x-*` attributes |
| **Laravel Jetstream** | ✅ Fully Compatible | All stacks supported |
| **Laravel Breeze** | ✅ Fully Compatible | All stacks supported |

### ✅ Compatible Debug Tools

Automatically skipped (no configuration needed):

- **Laravel Debugbar** - `_debugbar/*`
- **Laravel Telescope** - `telescope/*`
- **Laravel Horizon** - `horizon/*`
- **Ignition** - `_ignition/*`
- **Clockwork** - `clockwork/*`

### ❌ Incompatible Content

These are automatically skipped:

- Binary responses (file downloads)
- Streamed responses
- Non-HTML content types
- Redirect responses

---

## Performance Benchmarks

### Real-World Results

#### E-commerce Homepage
```
Before:
- HTML Size: 387 KB
- First Paint: 2.1s
- DOM Content Loaded: 2.8s
- Fully Loaded: 4.2s

After:
- HTML Size: 251 KB (-35%)
- First Paint: 1.4s (-33%)
- DOM Content Loaded: 2.0s (-29%)
- Fully Loaded: 3.5s (-17%)
```

#### Blog Post Page
```
Before:
- HTML Size: 156 KB
- First Paint: 1.8s
- PageSpeed Score: 72

After:
- HTML Size: 98 KB (-37%)
- First Paint: 1.2s (-33%)
- PageSpeed Score: 89 (+17)
```

#### Dashboard (SaaS App)
```
Before:
- HTML Size: 512 KB
- First Paint: 2.4s
- Time to Interactive: 3.9s

After:
- HTML Size: 333 KB (-35%)
- First Paint: 1.6s (-33%)
- Time to Interactive: 2.8s (-28%)
```

### Bandwidth Savings

For a site with **1 million page views/month**:

```
Average page size reduction: 88 KB
Monthly savings: 88 KB × 1,000,000 = 88 GB
Yearly savings: 88 GB × 12 = 1,056 GB = 1.03 TB

Cost savings (at $0.12/GB):
Monthly: $10.56
Yearly: $126.72
```

---

## Best Practices

### 1. Development vs Production

**Development** (`.env.local`):
```env
LARAVEL_PAGE_SPEED_ENABLE=false
```
This keeps HTML readable for debugging.

**Production** (`.env.production`):
```env
LARAVEL_PAGE_SPEED_ENABLE=true
```

### 2. Recommended Middleware Order

```php
protected $middleware = [
    // Framework middlewares first
    \Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode::class,
    \Illuminate\Foundation\Http\Middleware\ValidatePostSize::class,
    
    // Laravel Page Speed middlewares
    \VinkiusLabs\LaravelPageSpeed\Middleware\InlineCss::class,
    \VinkiusLabs\LaravelPageSpeed\Middleware\ElideAttributes::class,
    \VinkiusLabs\LaravelPageSpeed\Middleware\InsertDNSPrefetch::class,
    \VinkiusLabs\LaravelPageSpeed\Middleware\CollapseWhitespace::class,
    \VinkiusLabs\LaravelPageSpeed\Middleware\DeferJavascript::class,
];
```

### 3. Skip Non-HTML Routes

Always skip:
- API routes (`/api/*`)
- Admin panels (`/admin/*`)
- File downloads (`*.pdf`, `*.zip`)
- Debug tools

```php
'skip' => [
    'api/*',
    'admin/*',
    '*.pdf',
    '*.zip',
    '_debugbar/*',
],
```

### 4. Test Before Deploying

```bash
# Run tests
composer test

# Test on staging environment first
# Check for:
# - JavaScript functionality
# - CSS rendering
# - Form submissions
# - Third-party integrations
```

### 5. Monitor Performance

Use tools to verify improvements:
- Google PageSpeed Insights
- Chrome DevTools (Network tab)
- GTmetrix
- WebPageTest

---

## Troubleshooting

### Issue: Broken JavaScript

**Symptom**: JavaScript errors after enabling `DeferJavascript`.

**Solution**: Add `data-pagespeed-no-defer` to critical scripts:
```html
<script src="/js/critical.js" data-pagespeed-no-defer></script>
```

---

### Issue: Livewire Not Working

**Symptom**: Livewire directives not functioning.

**Solution**: `CollapseWhitespace` preserves Livewire spacing by default. If issues persist:

```php
// Add to skip routes
'skip' => [
    'livewire/*',
],
```

---

### Issue: CSS Styling Broken

**Symptom**: Styles not applying after enabling `InlineCss`.

**Solution**: This is rare. Check for:
- CSS specificity conflicts
- `!important` rules
- Dynamic styles added by JavaScript

---

### Issue: Debug Tools Not Working

**Symptom**: Debugbar/Telescope broken.

**Solution 1**: Check if routes are skipped:
```php
'skip' => [
    '_debugbar/*',
    'telescope/*',
],
```

**Solution 2**: If you have custom routes, add them:
```php
'skip' => [
    'admin/debugbar/*',  // Your custom route
],
```

---

### Issue: File Downloads Corrupted

**Symptom**: PDF/ZIP files corrupted.

**Solution**: Laravel Page Speed automatically skips binary responses. If issues persist, add explicit skip:
```php
'skip' => [
    '*.pdf',
    '*.zip',
    '*/downloads/*',
],
```

---

### Issue: Performance Not Improving

**Symptom**: No noticeable speed improvement.

**Checklist**:
1. ✅ Verify middleware is enabled in `app/Http/Kernel.php` (Laravel 10) or `bootstrap/app.php` (Laravel 11/12)
2. ✅ Check `LARAVEL_PAGE_SPEED_ENABLE=true` in `.env`
3. ✅ Clear cache: `php artisan cache:clear`
4. ✅ Check if routes are being skipped unintentionally
5. ✅ Measure with proper tools (DevTools Network tab)

---

## Advanced Topics

### Custom Middleware

Create your own optimization middleware:

```php
namespace App\Http\Middleware;

use Closure;

class CustomOptimization
{
    public function handle($request, Closure $next)
    {
        $response = $next($request);
        
        if ($this->shouldProcessResponse($response)) {
            $html = $response->getContent();
            
            // Your custom optimization logic
            $html = $this->customOptimize($html);
            
            $response->setContent($html);
        }
        
        return $response;
    }
    
    protected function shouldProcessResponse($response)
    {
        return $response->headers->get('Content-Type') === 'text/html';
    }
    
    protected function customOptimize($html)
    {
        // Example: Remove data attributes
        return preg_replace('/\s+data-[a-z-]+="[^"]*"/i', '', $html);
    }
}
```

---

## Next Steps

- 📗 **[API Optimization Guide →](../API-OPTIMIZATION.md)** - Optimize REST APIs
- 📕 **[Examples & Use Cases →](../API-EXAMPLES.md)** - Real-world scenarios
- 📖 **[Main README →](../README.md)** - Package overview

---

## Support

- 🐛 **Issues**: [GitHub Issues](https://github.com/vinkius-labs/laravel-page-speed/issues)
- 💬 **Discussions**: [GitHub Discussions](https://github.com/vinkius-labs/laravel-page-speed/discussions)
- 📧 **Email**: renato.marinho@s2move.com

---

<p align="center">
    Made with ❤️ by VinkiusLabs
</p>
